<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¥½ç¿’æ…£">
    <title>å¥½ç¿’æ…£</title>
<style>
    :root {
        --primary: #1a73e8; --success: #34a853; --warning: #fbc02d; --danger: #ea4335; --gray: #9aa0a6; --bg: #f0f2f5;
    }

    /* åŸºç¤è¨­å®šï¼šåŠ å¤§å­—é«”ï¼Œå¢åŠ åº•éƒ¨ç·©è¡é¿å…é®æ“‹ */
    body { 
        font-family: -apple-system, "Microsoft JhengHei", sans-serif; 
        margin: 0; background: var(--bg); padding-bottom: 120px; 
        color: #333; font-size: 30px; line-height: 1.5; 
    }

    /* æ³¨éŸ³å…¨å±€è¨­å®šï¼šå¼·åˆ¶ç½®é ‚ */
/* 1. æ³¨éŸ³èˆ‡åœ‹å­—çš„å®¹å™¨ */
ruby {
    display: inline-flex;
    flex-direction: column-reverse; /* è®“æ³¨éŸ³åœ¨åœ‹å­—ä¸Šæ–¹ */
    align-items: center;
    line-height: 1;           /* é‡é»ï¼šå°‡è¡Œé«˜è¨­ç‚º 1ï¼Œæ¶ˆé™¤å¤šé¤˜çš„ä¸Šä¸‹ç©ºæ ¼ */
    vertical-align: bottom;
}

/* 2. æ³¨éŸ³æœ¬é«” */
rt {
    font-size: 0.6em;
    color: var(--primary);
    line-height: 1;           /* é‡é»ï¼šæ¶ˆé™¤æ³¨éŸ³è‡ªèº«çš„é–“è· */
    display: block !important;
    text-align: center;
    padding: 0;               /* ç¢ºä¿æ²’æœ‰å…§è· */
    margin: 0 0 0px 0;       /* è² çš„ margin-bottom å¯ä»¥è®“æ³¨éŸ³æ›´è²¼è¿‘åœ‹å­— */
}


    /* é ‚éƒ¨æ¨™é¡Œ */
    .header { background: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    .header h2 { margin: 0; color: var(--primary); font-size: 40px; }
    
    .page { display: none; padding: 15px; animation: fadeIn 0.2s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* å¡ç‰‡èˆ‡æ¨™é¡Œ */
    .card { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    h3 { margin: 0 0 15px 0; border-left: 5px solid var(--primary); padding-left: 10px; font-size: 26px; }

    /* å°è¦½åˆ—å®¹å™¨ï¼šä¿®æ­£é«˜åº¦ */
    .nav { 
        position: fixed; bottom: 0; width: 100%; 
        background: white; display: flex; 
        border-top: 1px solid #ddd; z-index: 1000; 
        min-height: 105px; padding-bottom: env(safe-area-inset-bottom);
    }

    /* å°è¦½é …ç›®ï¼šä¿®æ­£æ­ªæ–œï¼Œçµ±ä¸€å±…ä¸­ */
    .nav-item { 
        flex: 1; text-align: center; color: #777; cursor: pointer; font-weight: bold; font-size: 18px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .nav-item.active { color: var(--primary); }

    /* åŠ å¤§åœ–ç¤º */
    .nav-item i { 
        display: block; font-size: 32px; margin-bottom: 8px; font-style: normal; line-height: 1;
    }

    /* é€²åº¦æ¢ */
    .progress-container { width: 100%; background: #eee; height: 16px; border-radius: 8px; margin: 12px 0; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--primary); transition: width 0.3s ease; }
    .progress-bar.complete { background: var(--warning); animation: flashYellow 0.5s ease-in-out 3; }
    @keyframes flashYellow { 0%, 100% { background: var(--warning); } 50% { background: #fff176; } }

    /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
    input { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 18px; }
    .main-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: bold; font-size: 20px; cursor: pointer; margin-bottom: 8px; }
    .item-row { padding: 15px 0; border-bottom: 1px solid #eee; }

/* è®“æŒ‰éˆ•èˆ‡çå‹µæ–‡å­—æ°´å¹³ä¸¦åˆ—çš„å®¹å™¨ */
.task-action-area {
    display: flex;
    align-items: center; /* å‚ç›´å±…ä¸­ */
      justify-content: space-between; /* é—œéµï¼šæ–‡å­—é å·¦ï¼ŒæŒ‰éˆ•é å³*/
    gap: 12px;           /* æŒ‰éˆ•èˆ‡æ–‡å­—çš„é–“è· */
    margin-top: 10px;
}

/* çå‹µç©åˆ†æ–‡å­—æ¨£å¼ */
.reward-info {
    font-size: 22px;       /* èˆ‡æŒ‰éˆ•å­—é«”å¤§å°ç›¸åŒ */
    font-weight: bold;
    color: var(--primary);
    line-height: 1;
    order:1;
}


/* ç¢ºä¿æŒ‰éˆ•å›ºå®šåœ¨å³å´ï¼Œå¯¬åº¦ç´„ 20-25% */
.task-action-area .main-btn {
    width: 25% !important; 
    margin: 0;
    padding: 10px 0;
    font-size: 18px;
    flex-shrink: 0;
    order: 2; /* å¼·åˆ¶æŒ‰éˆ•æ’åœ¨ç¬¬äºŒå€‹ */
}
/* å®¶é•·é–éš±å½¢å€å¡Šå®¹å™¨ */
.lock-overlay {
    display: flex;
    width: 100%;
    height: 60px; /* è§¸æ§å€åŸŸé«˜åº¦ */
    margin-bottom: 10px;
}

/* éš±å½¢æŒ‰éˆ•ï¼šå®Œå…¨é€æ˜ä½†å¯é»æ“Š */
.lock-btn {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
}

/* ç•¶è¨­å®šé è¢«é–å®šæ™‚ï¼Œè®“è£¡é¢çš„å¡ç‰‡çœ‹èµ·ä¾†è®Šæ·¡ */
.page-locked .card {
    opacity: 0.5;
    pointer-events: none; /* é–å®šæ™‚ç¦æ­¢é»æ“Šå¡ç‰‡å…§æ‰€æœ‰æ±è¥¿ */
}

/* è®“éš±å½¢å€å¡Šåœ¨é–å®šæ¨¡å¼ä¸‹ä¾ç„¶å¯ä»¥è¢«é»æ“Š */
.page-locked .lock-overlay {
    pointer-events: auto;
}



    /* æ—¥æ›†éƒ¨åˆ† */
    .cal-title { text-align: center; font-size: 22px; font-weight: bold; margin-bottom: 15px; color: var(--primary); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .cal-day { height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; border-radius: 8px; border: 1px solid #eee; font-size: 16px; cursor: pointer; }
    .cal-has-data { background: #fff9c4; border-color: #fbc02d; }
    .cal-selected { background: var(--primary) !important; color: white !important; }
/* é•è¦æ—¥æœŸçš„ç´…æ¡†èˆ‡ç´…é»æ¨£å¼ */
.cal-punish-mark {
    border: 2px solid var(--danger) !important;
    position: relative; /* è®“ç´…é»å¯ä»¥ç›¸å°æ–¼æ ¼å­å®šä½ */
}

/* ç´…é»æ¨™è¨˜ */
.cal-punish-mark::after {
    content: ""; /* ç©ºå…§å®¹ï¼Œåªé¡¯ç¤ºåœ“é» */
    position: absolute;
    top: 5px;
    right: 5px;
    width: 10px;
    height: 10px;
    background-color: var(--danger);
    border-radius: 50%; /* è®Šæˆåœ“å½¢ */
    box-shadow: 0 0 4px rgba(234, 67, 53, 0.5); /* æ·¡æ·¡çš„ç´…å…‰ */
}

    .weekday-picker { display: flex; gap: 4px; margin: 10px 0; }
    .day-btn { flex: 1; padding: 12px 0; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 14px; text-align: center; cursor: pointer; }
    .day-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
    
/* è­¦å‘ŠæŒ‰éˆ•ï¼šåˆå§‹è¨­å®šç‚ºéš±è— */
/* è­¦å‘ŠæŒ‰éˆ•ï¼šä¿®æ”¹ç‚ºåº•éƒ¨é•·å‹æ©«æ¢ */
/* è­¦å‘ŠæŒ‰éˆ•ï¼šé•·æ¢æ©«è·¨ç‰ˆ */
.warning-btn {
    display: none;             /* é è¨­éš±è— */
    position: fixed;
    bottom: 105px;             /* è·é›¢åº•éƒ¨é«˜åº¦ï¼Œé¿é–‹å°è¦½åˆ— */
    left: 0;                   /* å¾æœ€å·¦é‚Šé–‹å§‹ */
    width: 100%;               /* æ©«è·¨å·¦å³ */
    height: 50px;              /* æ‚¨è¦æ±‚çš„é«˜åº¦ 50px */
    background-color: #4A0000; /* åº•è‰²ï¼šæš—ç´…è‰² */
    color: white;              /* æ–‡å­—é¡è‰² */
    border: none;
    align-items: center;
    justify-content: center;
    font-size: 16px;           /* é©åˆ 30px çš„å­—é«”å¤§å° */
    font-weight: bold;
    z-index: 1500;
    
    /* æ ¸å¿ƒï¼šé˜² Android é¸å–®å¹²æ“¾ */
    touch-action: none !important;
    user-select: none;
    -webkit-user-select: none;
    cursor: pointer;
}

/* ä»»å‹™é  Active æ™‚é¡¯ç¤º */
.active .warning-btn {
    display: flex;
}

/* æŒ‰ä¸‹æ™‚çš„é–ƒçˆå‹•ç•« (æš—ç´…èˆ‡äº®ç´…åˆ‡æ›) */
@keyframes flash-warning {
    0% { background-color: #4A0000; }
    50% { background-color: #FF0000; }
    100% { background-color: #4A0000; }
}

/* é–ƒçˆç‹€æ…‹ Class */
.is-warning {
    animation: flash-warning 0.3s infinite; /* 0.3ç§’é–ƒçˆä¸€æ¬¡ */
}



/* è­¦å‘Šé é¢å°ˆå±¬çš„æ©˜è‰²é€²åº¦æ¢ */
.progress-bar.punish-style {
    background: #ff9800 !important; /* æ©˜è‰² */
}

</style>

</head>
<body>

<div class="header">
    <div style="font-size: 14px; color: #666;">å¯ç”¨ç©åˆ†</div>
    <h2 id="displayPoints">0</h2>
</div>

<div id="page1" class="page active page-locked">
    <div class="lock-overlay">
        <button class="lock-btn" onclick="unlockStep('L')"></button>
        <button class="lock-btn" onclick="unlockStep('R')"></button>
    </div>
    <div class="card">
        <h3>æ–°å¢ä»»å‹™</h3>
        <input type="text" id="tName" placeholder="ä»»å‹™åç¨±">
        <input type="text" id="tZy" placeholder="æ³¨éŸ³ (ç”¨å…¨å½¢é€—è™Ÿéš”é–‹)">
        
        <div class="type-toggle" style="display: flex; background: #eee; border-radius: 10px; padding: 4px; margin: 10px 0;">
            <label id="labelReward" class="active" style="flex:1; text-align:center; padding:10px; border-radius:8px; cursor:pointer; font-size:18px; font-weight:bold; background:var(--primary); color:white;">
                <input type="radio" name="tType" value="reward" checked onclick="updateToggleStyle()" style="display:none"> çå‹µ
            </label>
            <label id="labelPunish" style="flex:1; text-align:center; padding:10px; border-radius:8px; cursor:pointer; font-size:18px; font-weight:bold; color:#333;">
                <input type="radio" name="tType" value="punish" onclick="updateToggleStyle()" style="display:none"> æ‡²ç½°
            </label>
        </div>

        <input type="number" id="tTarget" placeholder="é”æˆ/é•è¦æ‰€éœ€æ¬¡æ•¸">
        <input type="number" id="tReward" placeholder="æ¯æ¬¡çå‹µ/æ‰£é™¤ç©åˆ†">
        ...

        <div class="weekday-picker">
            <div class="day-btn" data-day="0">æ—¥</div><div class="day-btn" data-day="1">ä¸€</div><div class="day-btn" data-day="2">äºŒ</div>
            <div class="day-btn" data-day="3">ä¸‰</div><div class="day-btn" data-day="4">å››</div><div class="day-btn" data-day="5">äº”</div>
            <div class="day-btn" data-day="6">å…­</div>
        </div>
        <button class="main-btn" onclick="saveTask()">ç¢ºèªæ–°å¢ä»»å‹™</button>
    </div>
    <div class="card">
        <h3>æ–°å¢é“å…·</h3>
        <input type="text" id="iName" placeholder="é“å…·åç¨±">
        <input type="text" id="iZy" placeholder="æ³¨éŸ³ (ç”¨å…¨å½¢é€—è™Ÿéš”é–‹)">
        <input type="number" id="iCost" placeholder="æ‰€éœ€ç©åˆ†">
        <button class="main-btn" style="background:var(--success)" onclick="saveItem()">ç¢ºèªæ–°å¢é“å…·</button>
    </div>
        <div class="card">
        <h3>ç®¡ç†ç¾æœ‰é“å…·</h3>
        <div id="manageItemList" style="margin-top: 10px;"></div>
    </div>

    <div class="card">
        <h3>æ•¸æ“šç®¡ç†</h3>
        <button class="main-btn" style="background:#607d8b" onclick="exportData()">ğŸ“¤ å‚™ä»½è³‡æ–™ (JSON)</button>
        <button class="main-btn" style="background:#9e9e9e" onclick="importData()">ğŸ“¥ é‚„åŸè³‡æ–™</button>
        <button onclick="clearAllData()" style="color:red; background:none; border:none; width:100%; margin-top:10px;margin-bottom:30px;padding:15px;font-size:12">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<div id="page2" class="page">
    <div class="card">
        <h3>ä»Šæ—¥ä»»å‹™</h3>
        <div id="activeTaskList"></div>
    </div>

    <div id="warningBtn" class="warning-btn">ğŸš¨ é•· æŒ‰ 3 ç§’ ç™¼ å‡º è­¦ å ± ğŸš¨</div>
</div>

<div id="page3" class="page">
    <div class="card">
        <h3>ç©åˆ†å•†åº—</h3>
        <div id="shopList"></div>
    </div>
</div>

<div id="page4" class="page">
    <div class="card">
        <h3>æˆ‘çš„èƒŒåŒ…</h3>
        <div id="myItemsList"></div>
    </div>
</div>

<div id="page5" class="page">
    <div class="card">
        <div id="calTitle" class="cal-title"></div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    <div class="card">
        <h3 id="detailDateTitle">é»æ“Šæ—¥æœŸæŸ¥çœ‹è©³æƒ…</h3>
        <div id="detailContent"></div>
    </div>
</div>
<div id="page6" class="page">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="border-left-color: var(--danger); color: var(--danger);">ğŸš¨ æ‡²ç½°æ¸…å–®</h3>
            <button class="main-btn" onclick="showPage(2)" style="width:auto; padding:5px 15px; font-size:16px;">è¿”å›ä»»å‹™</button>
        </div>
        <div id="punishTaskList"></div>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="showPage(1, this)">
        <i>âš™ï¸</i><ruby>è¨­å®š<rt>ã„•ã„œË‹ ã„‰ã„§ã„¥Ë‹</rt></ruby>
    </div>
    <div class="nav-item" onclick="showPage(2, this)">
        <i>âš¡</i><ruby>ä»»å‹™<rt>ã„–ã„£Ë‹ ã„¨Ë‹</rt></ruby>
    </div>
    <div class="nav-item" onclick="showPage(3, this)">
        <i>ğŸ›’</i><ruby>å•†åº—<rt>ã„•ã„¤ ã„‰ã„§ã„¢Ë‹</rt></ruby>
    </div>
    <div class="nav-item" onclick="showPage(4, this)">
        <i>ğŸ’</i><ruby>èƒŒåŒ…<rt>ã„…ã„Ÿ ã„…ã„ </rt></ruby>
    </div>
    <div class="nav-item" onclick="showPage(5, this)">
        <i>ğŸ“Š</i><ruby>è¨˜éŒ„<rt>ã„ã„§Ë‹ ã„Œã„¨Ë‹</rt></ruby>
    </div>
</div>



<script>
// --- å®¶é•·é–æ ¸å¿ƒé‚è¼¯ ---
let unlockSequence = [];
let isAdminMode = false;
let audioCtx = null;
let oscillator = null;
let gainNode = null;
let warningTimer = null;


function unlockStep(side) {
    // é€™è£¡ side æœƒæ¥æ”¶åˆ° HTML å‚³ä¾†çš„ 'L' æˆ– 'R'
    unlockSequence.push(side);
    
    // æª¢æŸ¥æœ€å¾Œå…©å€‹å‹•ä½œæ˜¯å¦ç‚º 'L' ç„¶å¾Œ 'R'
    const lastTwo = unlockSequence.slice(-2).join('');
    
    if (lastTwo === 'LR') {
        isAdminMode = true;
        // æˆåŠŸè§£é–ï¼šç§»é™¤ page-locked æ¨£å¼
        const settingPage = document.getElementById('page1');
        if (settingPage) {
            settingPage.classList.remove('page-locked');
        }
        triggerVibrate(); // éœ‡å‹•å›é¥‹
        alert("ğŸ”“ å®¶é•·æ¨¡å¼å·²é–‹å•Ÿ");
        renderManageItems(); // <--- è£œä¸Šé€™ä¸€è¡Œï¼Œè§£é–å¾Œç«‹åˆ»é¡¯ç¤ºç®¡ç†åˆ—è¡¨
        unlockSequence = []; // æ¸…ç©ºç´€éŒ„ï¼Œæº–å‚™ä¸‹æ¬¡ä½¿ç”¨
    }
}

// æ¸²æŸ“ç®¡ç†é“å…·åˆ—è¡¨ (å¸¶æœ‰åˆªé™¤æŒ‰éˆ•)
function renderManageItems() {
    const list = document.getElementById('manageItemList');
    if (!list) return;
    list.innerHTML = '';

    state.items.forEach((item, index) => {
        list.innerHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                <div>
                    <strong>${item.name}</strong> 
                    <small style="color:#666">(${item.cost} ç©åˆ†)</small>
                </div>
                <button onclick="deleteItem(${index})" style="background:none; border:none; color:red; cursor:pointer; font-size:18px;">ğŸ—‘ï¸</button>
            </div>`;
    });

    if (state.items.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999; font-size:14px;">ç›®å‰æ²’æœ‰é“å…·</p>';
    }
}

// åŸ·è¡Œåˆªé™¤é“å…·
function deleteItem(index) {
    if (confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${state.items[index].name}ã€å—ï¼Ÿé€™ä¸æœƒå½±éŸ¿å·²ç¶“å…Œæ›åˆ°èƒŒåŒ…è£¡çš„é“å…·ã€‚`)) {
        state.items.splice(index, 1);
        save();
        renderManageItems(); // é‡æ–°æ•´ç†ç®¡ç†åˆ—è¡¨
        renderShop();        // åŒæ­¥æ›´æ–°å•†åº—é é¢
    }
}

let warningTimer;
let audioCtx;
let oscillator;
let gainNode;

// 1. ç”¢ç”Ÿä½é »å—¡å—¡è²
let audioCtx = null; // æ”¾åœ¨ function å¤–å±¤

function startBuzz() {
    try {
        // å¦‚æœ init æ²’è§£é–åˆ°ï¼Œé€™è£¡åšäºŒæ¬¡ä¿éšª
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // å¿…é ˆå†æ¬¡ç¢ºä¿ state æ˜¯ running
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();

        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(300, audioCtx.currentTime); 
        oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 1);
        oscillator.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 2);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 3);
        
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime); 
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
    } catch(e) { 
        console.log("Audio Error:", e); 
    }
}
function stopBuzz() {
    if (oscillator) {
        oscillator.stop();
        oscillator.disconnect();
    }
    if (audioCtx) audioCtx.close();
}

// 2. é•·æŒ‰é‚è¼¯

// A. å•Ÿå‹•è­¦å‘Š
// A. å•Ÿå‹•è­¦å‘Šï¼šæŒ‰ä¸‹æ™‚è§¸ç™¼
// --- è­¦å‘ŠåŠŸèƒ½æ ¸å¿ƒé‚è¼¯ ---

// A. å•Ÿå‹•è­¦å‘Š
function handleWarningStart() {
    stopEffects(); // æ¸…ç†èˆŠç‹€æ…‹

    const btn = document.getElementById('warningBtn');
    if (btn) btn.classList.add('is-warning'); // é–‹å§‹é–ƒçˆ
    
    startBuzz(); // æ’­æ”¾è­¦å ±è²

    // å•Ÿå‹• 3 ç§’è¨ˆæ™‚
    warningTimer = setTimeout(() => {
        finishWarning();
    }, 3000);
}

// B. åœæ­¢ç‰¹æ•ˆ
function handleWarningEnd() {
    stopEffects();
}

// C. æ¸…ç†å‡½å¼
function stopEffects() {
    if (warningTimer) {
        clearTimeout(warningTimer);
        warningTimer = null;
    }
    const btn = document.getElementById('warningBtn');
    if (btn) btn.classList.remove('is-warning'); // åœæ­¢é–ƒçˆ
    
    stopBuzz(); // åœæ­¢è²éŸ³
    if ("vibrate" in navigator) navigator.vibrate(0);
}

// D. è·³è½‰æ‡²ç½°é 
function finishWarning() {
    stopEffects();
    showPage(6); // é€²å…¥ Page 6
}

// E. é‡æ–°ç¶å®šæŒ‰éˆ• (é€™æ˜¯è§£æ±º Android æ²’åæ‡‰çš„é—œéµ)
function setupWarningButton() {
    const btn = document.getElementById('warningBtn');
    if (!btn) return;

    // å¾¹åº•å°é–å³éµé¸å–®
    btn.addEventListener('contextmenu', e => e.preventDefault());

    // æŒ‰ä¸‹
    btn.addEventListener('pointerdown', e => {
        e.preventDefault();
        handleWarningStart();
    }, { passive: false });

    // æ”¾é–‹ã€é›¢é–‹ã€å–æ¶ˆ
    const endAction = (e) => {
        e.preventDefault();
        handleWarningEnd();
    };
    btn.addEventListener('pointerup', endAction);
    btn.addEventListener('pointercancel', endAction);
    btn.addEventListener('pointerleave', endAction);
}


// C. æ ¸å¿ƒæ¸…ç†å‡½å¼ï¼šç¢ºä¿æ‰€æœ‰ç‰¹æ•ˆç«‹åˆ»æ¶ˆå¤±
function stopEffects() {
    if (warningTimer) {
        clearTimeout(warningTimer);
        warningTimer = null;
    }
    
    // ç§»é™¤æŒ‰éˆ•çš„é–ƒçˆç‹€æ…‹
    const btn = document.getElementById('warningBtn');
    if (btn) btn.classList.remove('is-warning');
    
    // åœæ­¢è­¦å ±éŸ³æ•ˆ
    stopBuzz();
    
    // åœæ­¢æ‰‹æ©Ÿéœ‡å‹•
    if ("vibrate" in navigator) navigator.vibrate(0);
}

// D. æˆåŠŸè§¸ç™¼ï¼š3 ç§’åˆ°ï¼Œè‡ªå‹•è·³è½‰åˆ°æ‡²ç½°é 
function finishWarning() {
    stopEffects();
    showPage(6); // é€™è£¡æ˜¯è·³è½‰åˆ°æ‚¨çš„ã€Œæ‡²ç½°ä»»å‹™æ¸…å–®ã€é é¢
}

function renderPunishTasks() {
    const list = document.getElementById('punishTaskList');
    const dStr = getTodayStr();
    
    if (!state.dailyLogs[dStr]) state.dailyLogs[dStr] = { done: {}, buy: {}, use: {} };
    
    list.innerHTML = '';
    const punishTasks = state.tasks.filter(t => t.isPunish === true);

    punishTasks.forEach(t => {
        const count = state.dailyLogs[dStr].done[t.id] || 0;
        const progress = (count / t.target) * 100;
        
        // ã€é—œéµé‚è¼¯ã€‘ï¼šå¦‚æœæ¬¡æ•¸å·²é”åˆ°ç›®æ¨™ï¼Œå‰‡å°‡æŒ‰éˆ•è¨­ç‚ºç¦ç”¨ç‹€æ…‹ (disabled)
        const isFull = count >= t.target;

        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-end">
                <strong style="color:var(--danger)">${formatRuby(t.name, t.zy)}</strong>
                <span style="font-size:16px; color:#666;">${count} / ${t.target}</span>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar punish-style ${isFull ? 'complete' : ''}" 
                     style="width: ${Math.min(progress, 100)}%"></div>
            </div>
 <div class="task-action-area">
<button class="main-btn" 
                    style="background:${isFull ? '#ccc' : 'var(--danger)'}" 
                    onclick="doAction(${t.id})" 
                    ${isFull ? 'disabled' : ''}>
                    ${isFull ? 'å·²æ‰£åˆ†' : '+1 é•è¦'}
                </button>
                <div class="reward-info" style="color:var(--danger)">
                    ${formatRuby("æ‰£é™¤", "ã„ã„¡Ë‹ ã„”ã„¨ËŠ")}ï¼š${t.reward} ç©åˆ†
                </div>
            </div>
        `;
        list.appendChild(div);
    });

    if (punishTasks.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">ç›®å‰æ²’æœ‰è¨­å®šæ‡²ç½°é …ç›®</p>';
    }
}

  // --- æ ¸å¿ƒè³‡æ–™ç‹€æ…‹ ---
    let state = {
        points: 0,
        tasks: [],
        items: [],
        inventory: {},
        dailyLogs: {}
    };

    // è¼‰å…¥è³‡æ–™
function init() {
    const saved = localStorage.getItem('taskMasterV7');
    if (saved) state = JSON.parse(saved);
    document.getElementById('displayPoints').innerText = state.points;
    
    setupWarningButton(); 

    // --- é‡å° iOS æ¡Œé¢æ·å¾‘ (PWA) çš„çµ‚æ¥µè§£é– ---
    const unlockAudio = () => {
        // å¦‚æœé‚„æ²’å»ºç«‹éï¼Œå°±å»ºç«‹ä¸€å€‹
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // é—œéµï¼šå¦‚æœç‹€æ…‹æ˜¯ suspendedï¼Œå¼·åˆ¶ resume
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        // å»ºç«‹ä¸€å€‹ 0.0001 ç§’çš„ç„¡è²éœ‡ç›ªå™¨ä¸¦ç«‹å³æ’­æ”¾ï¼Œé€™èƒ½é¨™é iOS çš„éœéŸ³é–
        const silentOsc = audioCtx.createOscillator();
        const silentGain = audioCtx.createGain();
        silentGain.gain.value = 0.0001; 
        silentOsc.connect(silentGain);
        silentGain.connect(audioCtx.destination);
        silentOsc.start(0);
        silentOsc.stop(0.001);

        console.log("iOS Audio Context Unlocked: " + audioCtx.state);
        
        // è§£é–æˆåŠŸå¾Œï¼Œç§»é™¤ç›£è½å™¨ä»¥ç¯€çœé›»åŠ›
        window.removeEventListener('touchstart', unlockAudio);
        window.removeEventListener('click', unlockAudio);
    };

    // ç›£è½æ‰€æœ‰å¯èƒ½çš„è§¸ç¢°å‹•ä½œ
    window.addEventListener('touchstart', unlockAudio, { passive: false });
    window.addEventListener('click', unlockAudio);
}



    function save() {
        localStorage.setItem('taskMasterV7', JSON.stringify(state));
        document.getElementById('displayPoints').innerText = state.points;
    }

    const getTodayStr = () => new Date().toLocaleDateString('en-CA');

    // --- åˆ†é åˆ‡æ›æ ¸å¿ƒé‚è¼¯ ---
// ä¿®æ”¹å¾Œçš„åˆ†é åˆ‡æ›ï¼šç¢ºä¿æ¯ä¸€æ¬¡åˆ‡æ›éƒ½é‡ç½®é–å®šç‹€æ…‹
function showPage(num, el) {
    // 1. å¼·åˆ¶é‡ç½®å®¶é•·æ¨¡å¼ç‹€æ…‹ï¼ˆé™¤äº†åˆ‡æ›åˆ°è¨­å®šé æœ¬èº«æ™‚éœ€è¦åˆ¤æ–·ï¼Œå…¶ä»–é é¢ä¸€å¾‹é–å®šï¼‰
    isAdminMode = false;
    unlockSequence = [];
    
    const settingPage = document.getElementById('page1');
    if (settingPage) {
        settingPage.classList.add('page-locked');
    }

    // 2. åˆ‡æ›é é¢ Active ç‹€æ…‹
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const target = document.getElementById('page' + num);
    if (target) target.classList.add('active');
    
    // 3. æ›´æ–°å°è¦½åˆ—æŒ‰éˆ•é¡è‰²
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    if (el) el.classList.add('active');

    // 4. æ ¹æ“šç·¨è™ŸåŸ·è¡Œå°æ‡‰çš„æ¸²æŸ“
    if (num === 2) renderTasks();
    if (num === 3) renderShop();
        if (num === 4) renderInventory();
    if (num === 5) renderCalendar();
    if (num === 6) renderPunishTasks(); // é€²å…¥æ‡²ç½°é 
    
    window.scrollTo(0, 0);
}


    // --- ç‰¹æ•ˆèˆ‡åé¥‹ ---
    function playDing() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start(); osc.stop(ctx.currentTime + 0.5);
        } catch(e) { console.log("Audio not supported"); }
    }

    function triggerVibrate() {
        if ("vibrate" in navigator) navigator.vibrate([100, 50, 100]);
    }

    // --- è¨­å®šåˆ†é åŠŸèƒ½ ---
    document.querySelectorAll('.day-btn').forEach(btn => {
        btn.onclick = () => btn.classList.toggle('selected');
    });

function updateToggleStyle() {
    const isPunish = document.querySelector('input[name="tType"]:checked').value === 'punish';
    document.getElementById('labelReward').style.background = isPunish ? '#eee' : 'var(--primary)';
    document.getElementById('labelReward').style.color = isPunish ? '#333' : 'white';
    document.getElementById('labelPunish').style.background = isPunish ? 'var(--danger)' : '#eee';
    document.getElementById('labelPunish').style.color = isPunish ? 'white' : '#333';
}

function saveTask() {
    const name = document.getElementById('tName').value.trim();
    const zy = document.getElementById('tZy').value.trim();
    const target = parseInt(document.getElementById('tTarget').value);
    const reward = parseInt(document.getElementById('tReward').value);
    
    // é—œéµï¼šæŠ“å–ç›®å‰ Radio Button çš„é¸æ“‡ç‹€æ…‹
    const typeEl = document.querySelector('input[name="tType"]:checked');
    const isPunish = typeEl ? (typeEl.value === 'punish') : false;
    
    const days = Array.from(document.querySelectorAll('.day-btn.selected')).map(b => parseInt(b.dataset.day));
    
    if (!name || isNaN(target) || isNaN(reward)) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

    state.tasks.push({ 
        id: Date.now(), 
        name: name, 
        zy: zy,
        isPunish: isPunish, // å­˜å…¥æ‡²ç½°æ¨™ç±¤
        target: target, 
        reward: reward, 
        days: days 
    });

    save();
    alert(isPunish ? "âš ï¸ æ‡²ç½°é …ç›®å·²æ–°å¢" : "âœ… ä»»å‹™æ–°å¢æˆåŠŸï¼");

    // æ¸…ç©ºæ¬„ä½ä¸¦é‡è¨­é–‹é—œ
    document.getElementById('tName').value = '';
    document.getElementById('tZy').value = '';
    document.getElementById('tTarget').value = '';
    document.getElementById('tReward').value = '';
    document.querySelector('input[name="tType"][value="reward"]').checked = true;
    updateToggleStyle();
}


function saveItem() {
    // 1. å®‰å…¨æŠ“å–æ¬„ä½ï¼šå…ˆç¢ºèªæ¬„ä½æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢ç¨‹å¼ç•¶æ©Ÿ
    const nameEl = document.getElementById('iName');
    const zyEl = document.getElementById('iZy');
    const costEl = document.getElementById('iCost');

    // 2. é˜²å‘†æª¢æŸ¥ï¼šå¦‚æœ HTML æ¼å¯«äº†æ¬„ä½ï¼Œé€™è£¡æœƒå ±éŒ¯ä½†ä¸æœƒè®“æ•´å€‹ç¶²é æ­»æ‰
    if (!nameEl || !zyEl || !costEl) {
        console.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° iName, iZy æˆ– iCost æ¬„ä½ï¼è«‹æª¢æŸ¥ HTMLã€‚");
        alert("ç¨‹å¼æ‰¾ä¸åˆ°è¼¸å…¥æ¡†ï¼Œè«‹æª¢æŸ¥è¨­å®šé é¢ï¼");
        return;
    }

    // 3. æŠ“å–æ•¸å€¼
    const name = nameEl.value.trim();
    const zy = zyEl.value.trim();
    const cost = parseInt(costEl.value);

    // 4. é‚è¼¯åˆ¤æ–·ï¼šé€™å°±æ˜¯ä½ èªªçš„ã€Œæ²’å¡«å¯«ã€æ™‚æ‡‰è©²è¦å‡ºç¾çš„æç¤º
    if (!name || isNaN(cost)) {
        alert("âš ï¸ è«‹å¡«å¯«é“å…·åç¨±èˆ‡ç©åˆ†ï¼"); // å¦‚æœæ²’å¡«ï¼Œç¾åœ¨æœƒå½ˆå‡ºé€™å€‹
        return;
    }

    // 5. æ­£ç¢ºå­˜å…¥ state (ä½¿ç”¨ key: value å®Œæ•´å¯«æ³•æœ€å®‰å…¨)
    state.items.push({ 
        name: name, 
        zy: zy, 
        cost: cost 
    });

    // 6. å„²å­˜ä¸¦åé¥‹
    save(); 
    alert("âœ… é“å…·æ–°å¢æˆåŠŸï¼");
renderManageItems(); // <--- è£œä¸Šé€™ä¸€è¡Œ
    // 7. æ¸…ç©ºæ¬„ä½
    nameEl.value = '';
    zyEl.value = '';
    costEl.value = '';
}

function formatRuby(text, zyStr) {
    // 1. å¦‚æœæ²’è¼¸å…¥æ³¨éŸ³ï¼Œç›´æ¥å›å‚³åŸæ–‡å­—
    if (!zyStr || zyStr.trim() === "") return text;

    const chars = text.split('');
    const zys = zyStr.split('ï¼Œ'); // ç¢ºä¿ä½ æ˜¯ç”¨å…¨å½¢é€—è™Ÿ
    let html = ''; // å…ˆå»ºç«‹ä¸€å€‹ç©ºç›’å­

    // 2. ä¸€å€‹å­—ä¸€å€‹å­—è™•ç†
    chars.forEach((c, i) => {
        const z = zys[i] ? zys[i].trim() : ''; // å–å¾—å°æ‡‰æ³¨éŸ³ï¼Œæ²’æœ‰å°±ç•™ç©º
        html += `<ruby>${c}<rt>${z}</rt></ruby>`; // æŠŠæ³¨éŸ³å’Œå­—åŒ…èµ·ä¾†ï¼Œã€Œé»ã€åˆ° html å¾Œé¢
    });

    // 3. æœ€å¾ŒæŠŠæ•´ä¸²çµ„å¥½çš„ HTML ä¸Ÿå›å»
    return html; 
}

    // --- ä»»å‹™åˆ†é æ ¸å¿ƒæ¸²æŸ“ ---
    function renderTasks() {
        const list = document.getElementById('activeTaskList');
        const dStr = getTodayStr();
        const dayOfWeek = new Date().getDay();
        
        if (!state.dailyLogs[dStr]) state.dailyLogs[dStr] = { done: {}, buy: {}, use: {} };
        
        list.innerHTML = '';
        state.tasks.forEach(t => {
            if (t.isPunish) return; 
            if (t.days.length > 0 && !t.days.includes(dayOfWeek)) return;
            
            const count = state.dailyLogs[dStr].done[t.id] || 0;
            const isFull = count >= t.target;
            const progress = (count / t.target) * 100;

            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-end">
                    <strong>${formatRuby(t.name, t.zy)}</strong>
                    <span style="font-size:16px; color:#666;">${count} / ${t.target}</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar ${isFull ? 'complete' : ''}" style="width: ${Math.min(progress, 100)}%"></div>
                </div>
                <div class="task-action-area">
                    <button class="main-btn" style="background:${isFull ? '#ccc' : ''}" 
                        onclick="doAction(${t.id})" ${isFull ? 'disabled' : ''}>
                        ${isFull ? 'âœ…' : '+1'}
                    </button>
                    <div class="reward-info">
                        ${formatRuby("çå‹µ", "ã„ã„§ã„¤Ë‡ï¼Œã„Œã„§Ë‹")}ï¼š${t.reward} ç©åˆ†
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
        if(list.innerHTML === '') list.innerHTML = '<p style="text-align:center; color:#999;">ä»Šæ—¥ç„¡è¨­å®šä»»å‹™</p>';
    }

    function doAction(id) {
    const dStr = getTodayStr();
    const task = state.tasks.find(t => t.id === id);
    
    // 1. ç¢ºä¿ä»Šå¤©æœ‰ç´€éŒ„å®¹å™¨
    if (!state.dailyLogs[dStr]) state.dailyLogs[dStr] = { done: {}, buy: {}, use: {} };
    
    // 2. å¢åŠ æ¬¡æ•¸ç´€éŒ„
    state.dailyLogs[dStr].done[id] = (state.dailyLogs[dStr].done[id] || 0) + 1;
    const currentCount = state.dailyLogs[dStr].done[id];
    
    if (task.isPunish) {
        // --- æ‡²ç½°é‚è¼¯ï¼šåªæœ‰é”åˆ°ç›®æ¨™æ¬¡æ•¸æ™‚ï¼Œæ‰åŸ·è¡Œæ‰£åˆ† ---
        if (currentCount === task.target) {
            state.points -= task.reward;
            if (state.points < 0) state.points = 0; // ç¢ºä¿ç©åˆ†ä¸ç‚ºè² æ•¸
            
            triggerLongVibrate(); // åŸ·è¡Œå¼·çƒˆéœ‡å‹•æç¤ºå·²æ‰£åˆ†
            alert(`âš ï¸ é•è¦æ¬¡æ•¸å·²é”æ¨™ï¼šæ‰£é™¤ ${task.reward} ç©åˆ†ï¼`);
        }
        renderPunishTasks(); // é‡æ–°æ¸²æŸ“æ‡²ç½°é 
    } else {
        // --- çå‹µé‚è¼¯ï¼šåªæœ‰é”åˆ°ç›®æ¨™æ¬¡æ•¸æ™‚ï¼Œæ‰çµ¦äºˆçå‹µ ---
        if (currentCount === task.target) {
            state.points += task.reward;
            triggerVibrate(); // ä¸€èˆ¬éœ‡å‹•
            playDing();       // æ’­æ”¾çå‹µéŸ³æ•ˆ
        }
        renderTasks(); // é‡æ–°æ¸²æŸ“ä»»å‹™é 
    }
    
    save(); // å„²å­˜åˆ° LocalStorage
}

    // --- å•†åº—èˆ‡èƒŒåŒ…æ¸²æŸ“ ---
function renderShop() {
    const list = document.getElementById('shopList');
    list.innerHTML = '';
    state.items.forEach(i => {
        const canBuy = state.points >= i.cost;
        list.innerHTML += `
            <div class="item-row" style="display:flex; justify-content:space-between; align-items:center">
                <div><strong>${formatRuby(i.name, i.zy)}</strong><br><small>${i.cost} ç©åˆ†</small></div>
                <button class="main-btn" style="width:auto; padding:8px 15px; background:${canBuy ? 'var(--warning)' : '#eee'}" 
                    onclick="buyItem('${i.name}', ${i.cost})" ${canBuy ? '' : 'disabled'}>å…Œæ›</button>
            </div>`;
    });
}

  function buyItem(name, cost) {
        const dStr = getTodayStr();
        state.points -= cost;
        state.inventory[name] = (state.inventory[name] || 0) + 1;
        if(!state.dailyLogs[dStr]) state.dailyLogs[dStr] = { done:{}, buy:{}, use:{} };
        state.dailyLogs[dStr].buy[name] = (state.dailyLogs[dStr].buy[name] || 0) + 1;
        save();
    triggerVibrate(); // è§¸ç™¼éœ‡å‹•
    alert(`å…Œæ›æˆåŠŸï¼š${name}`); // æç¤ºæˆåŠŸ
    renderShop();
}
function renderInventory() {
    const list = document.getElementById('myItemsList');
    list.innerHTML = '';
    for (let name in state.inventory) {
        if (state.inventory[name] > 0) {
            // é—œéµï¼šå¾é“å…·æ¸…å–®ä¸­æ‰¾å›è©²é“å…·çš„åŸå§‹è³‡æ–™(åŒ…å«æ³¨éŸ³)
            const itemData = state.items.find(i => i.name === name) || {zy: ""};
            
            list.innerHTML += `
                <div class="item-row" style="display:flex; justify-content:space-between; align-items:center">
                    <div><strong>${formatRuby(name, itemData.zy)}</strong> (æŒæœ‰: ${state.inventory[name]})</div>
                    <button class="main-btn" style="width:auto; padding:8px 15px; background:var(--success)" onclick="useItem('${name}')">ä½¿ç”¨</button>
                </div>`;
        }
    }
}

    function useItem(name) {
        const dStr = getTodayStr();
        state.inventory[name]--;
        if(!state.dailyLogs[dStr]) state.dailyLogs[dStr] = { done:{}, buy:{}, use:{} };
        state.dailyLogs[dStr].use[name] = (state.dailyLogs[dStr].use[name] || 0) + 1;
        save();
        renderInventory();
    triggerVibrate(); // è§¸ç™¼éœ‡å‹•
    alert(`ä½¿ç”¨äº†ï¼š${name}`); // æç¤ºæˆåŠŸ
    renderInventory();
}
    // --- æ—¥æ›†æ ¸å¿ƒæ¸²æŸ“ ---
        function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        document.getElementById('calTitle').innerText = `${y} å¹´ ${m + 1} æœˆ`;
        
        const firstDay = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));

        for (let i = 1; i <= daysInMonth; i++) {
            const date = new Date(y, m, i);
            const dStr = date.toLocaleDateString('en-CA');
            const hasData = state.dailyLogs[dStr];
            
            // --- æ–°å¢ï¼šæª¢æŸ¥ç•¶å¤©æ˜¯å¦æœ‰é•è¦ç´€éŒ„ ---
            let hasPunish = false;
            if (hasData && hasData.done) {
                hasPunish = Object.keys(hasData.done).some(id => {
                    const t = state.tasks.find(task => task.id == id);
                    return t && t.isPunish;
                });
            }

            const div = document.createElement('div');
            // åœ¨é€™è£¡åŠ å…¥ cal-punish-mark é¡å
            div.className = `cal-day ${dStr === getTodayStr() ? 'cal-today' : ''} ${hasData ? 'cal-has-data' : ''} ${hasPunish ? 'cal-punish-mark' : ''}`;
            
            div.innerText = i;
            div.onclick = (e) => {
                document.querySelectorAll('.cal-day').forEach(d => d.classList.remove('cal-selected'));
                e.currentTarget.classList.add('cal-selected');
                showDetail(dStr);
            };
            grid.appendChild(div);
        }
    }


function showDetail(dStr) {
    const content = document.getElementById('detailContent');
    document.getElementById('detailDateTitle').innerText = dStr + " è©³æƒ…";
    const log = state.dailyLogs[dStr] || { done: {}, buy: {}, use: {} };
    
    let html = "";

    // 1. è™•ç†ä»»å‹™èˆ‡é•è¦ç´€éŒ„
    const doneIds = Object.keys(log.done);
    if (doneIds.length > 0) {
        let rewardHtml = "<strong>âœ… å®Œæˆä»»å‹™:</strong><br>";
        let punishHtml = "<strong>ğŸš¨ é•è¦ç´€éŒ„:</strong><br>";
        let hasReward = false;
        let hasPunish = false;

        doneIds.forEach(id => {
            const task = state.tasks.find(t => t.id == id);
            if (task) {
                const count = log.done[id];
                if (task.isPunish) {
                    // è¨ˆç®—å¯¦éš›æ‰£åˆ†ï¼šé”æ¨™æ¬¡æ•¸æ‰ç®—ä¸€æ¬¡æ‰£åˆ†
                    const penaltyTimes = Math.floor(count / task.target);
                    const totalDeduction = penaltyTimes * task.reward;
                    
                    punishHtml += `<span style="color:var(--danger)">${task.name}: é•è¦ ${count} æ¬¡ (å…±æ‰£ ${totalDeduction} åˆ†)</span><br>`;
                    hasPunish = true;
                } else {
                    // çå‹µä»»å‹™ï¼šé¡¯ç¤ºé€²åº¦èˆ‡æ˜Ÿæ˜Ÿï¼ˆæ»¿ç›®æ¨™æ¬¡æ•¸çµ¦ä¸€é¡†æ˜Ÿï¼‰
                    const rewardTimes = Math.floor(count / task.target);
                    const stars = rewardTimes > 0 ? ' â˜…'.repeat(rewardTimes) : '';
                    rewardHtml += `${task.name}: ${count}/${task.target}${stars}<br>`;
                    hasReward = true;
                }
            }
        });

        if (hasReward) html += rewardHtml + "<br>";
        if (hasPunish) html += punishHtml + "<br>";
    } else {
        html += "<p style='color:#999'>ç•¶æ—¥ç„¡ä»»å‹™æ´»å‹•</p>";
    }
    
    // 2. é¡¯ç¤ºå…Œæ›èˆ‡ä½¿ç”¨ç´€éŒ„
    html += "<strong>ğŸ’ é“å…·ç´€éŒ„:</strong><br>";
    let hasInventoryLog = false;
    
    // é¡¯ç¤ºå…Œæ›ç´€éŒ„
    for(let n in log.buy) { 
        html += `å…Œæ›: ${n} x${log.buy[n]}<br>`; 
        hasInventoryLog = true; 
    }
    // é¡¯ç¤ºä½¿ç”¨ç´€éŒ„
    for(let n in log.use) { 
        html += `ä½¿ç”¨: ${n} x${log.use[n]}<br>`; 
        hasInventoryLog = true; 
    }
    
    if(!hasInventoryLog) html += "ç„¡é“å…·ç´€éŒ„";
    
    content.innerHTML = html;
}



    // --- è³‡æ–™ç®¡ç† ---
    function exportData() {
        const blob = new Blob([JSON.stringify(state)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `task_master_backup_${getTodayStr()}.json`;
        a.click();
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    state = JSON.parse(ev.target.result);
                    save();
                    location.reload();
                } catch(e) { alert("æª”æ¡ˆè®€å–éŒ¯èª¤"); }
            };
            reader.readAsText(e.target.files[0]);
        };
        input.click();
    }

    function clearAllData() {
        if (confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }

    // å•Ÿå‹•
    init();
</script>
</body>
</html>

    





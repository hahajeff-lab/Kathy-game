<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™å¤§å¸« V4 - æ•¸æ“šå¯è¦–åŒ–ç‰ˆ</title>
    <style>
        :root {
            --primary: #1a73e8; --success: #34a853; --warning: #f9ab00; --danger: #ea4335; --gray: #9aa0a6; --bg: #f0f2f5;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; color: #333; }
        
        /* é ‚éƒ¨ç©åˆ† */
        .header { background: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .header h2 { margin: 0; color: var(--primary); font-size: 28px; }

        /* åˆ†é  */
        .page { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        h3 { margin: 0 0 15px 0; border-left: 5px solid var(--primary); padding-left: 10px; font-size: 18px; display: flex; justify-content: space-between; }

        /* é€²åº¦æ¢è¨­è¨ˆ */
        .progress-container { width: 100%; background: #eee; height: 8px; border-radius: 4px; margin: 8px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); transition: width 0.3s ease; }
        .progress-bar.complete { background: var(--success); }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .weekday-picker { display: flex; gap: 5px; margin: 10px 0; }
        .day-btn { flex: 1; padding: 10px 0; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 13px; text-align: center; }
        .day-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .main-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: bold; font-size: 16px; }

        /* åˆ—è¡¨é …ç›® */
        .item-row { padding: 12px 0; border-bottom: 1px solid #eee; }
        .row-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .status-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .tag-done { background: #d4edda; color: var(--success); }
        .tag-todo { background: #fff3cd; color: #856404; }

        /* å°è¦½åˆ— */
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; font-size: 11px; color: #777; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 3px; font-style: normal; }

        /* æ—¥æ›† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day { height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; border-radius: 8px; font-size: 14px; cursor: pointer; border: 1px solid #eee; }
        .cal-today { border: 2px solid var(--primary); color: var(--primary); font-weight: bold; }
        .cal-selected { background: var(--primary) !important; color: white !important; }
        .cal-has-data { background: #e8f0fe; }
        .dot { font-size: 10px; line-height: 0; margin-top: 4px; color: var(--success); }

        /* è©³æƒ…åˆ—è¡¨ */
        .detail-list { font-size: 14px; margin-top: 10px; }
        .detail-item { padding: 5px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 14px; color: #666;">å¯ç”¨ç©åˆ†</div>
    <h2 id="displayPoints">0</h2>
</div>

<div id="page1" class="page active">
    <div class="card">
        <h3>æ–°å¢ä»»å‹™</h3>
        <input type="text" id="tName" placeholder="ä»»å‹™åç¨±">
        <input type="number" id="tTarget" placeholder="æ¯æ—¥ç›®æ¨™æ¬¡æ•¸">
        <input type="number" id="tReward" placeholder="å–®æ¬¡å®Œæˆç©åˆ†çå‹µ">
        <div class="weekday-picker">
            <div class="day-btn" data-day="0">æ—¥</div><div class="day-btn" data-day="1">ä¸€</div><div class="day-btn" data-day="2">äºŒ</div>
            <div class="day-btn" data-day="3">ä¸‰</div><div class="day-btn" data-day="4">å››</div><div class="day-btn" data-day="5">äº”</div>
            <div class="day-btn" data-day="6">å…­</div>
        </div>
        <button class="main-btn" onclick="saveTask()">ç¢ºèªæ–°å¢</button>
    </div>
    <div class="card">
        <h3>æ–°å¢é“å…·</h3>
        <input type="text" id="iName" placeholder="é“å…·åç¨±">
        <input type="number" id="iCost" placeholder="æ‰€éœ€ç©åˆ†">
        <button class="main-btn" style="background:var(--success)" onclick="saveItem()">ç¢ºèªæ–°å¢</button>
    </div>
    <button onclick="clearAllData()" style="color:red; background:none; border:none; width:100%; padding:10px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
</div>

<div id="page2" class="page">
    <div class="card">
        <h3>ä»Šæ—¥ä»»å‹™ <span id="todayStr" style="font-size:12px; font-weight:normal; color:#999;"></span></h3>
        <div id="activeTaskList"></div>
    </div>
</div>

<div id="page3" class="page">
    <div class="card">
        <h3>ç©åˆ†å•†åº—</h3>
        <div id="shopList"></div>
    </div>
</div>

<div id="page4" class="page">
    <div class="card">
        <h3>æˆ‘çš„èƒŒåŒ…</h3>
        <div id="myItemsList"></div>
    </div>
</div>

<div id="page5" class="page">
    <div class="card">
        <h3>æ—¥æ›†è¨˜éŒ„</h3>
        <div class="calendar-grid" id="calendarHeader">
            <div style="text-align:center; font-size:12px; color:#999;">æ—¥</div><div style="text-align:center; font-size:12px; color:#999;">ä¸€</div>
            <div style="text-align:center; font-size:12px; color:#999;">äºŒ</div><div style="text-align:center; font-size:12px; color:#999;">ä¸‰</div>
            <div style="text-align:center; font-size:12px; color:#999;">å››</div><div style="text-align:center; font-size:12px; color:#999;">äº”</div>
            <div style="text-align:center; font-size:12px; color:#999;">å…­</div>
        </div>
        <div class="calendar-grid" id="calendarGrid" style="margin-top:5px;"></div>
    </div>

    <div class="card" id="detailCard">
        <h3 id="detailDateTitle">é»æ“Šæ—¥æœŸæŸ¥çœ‹è©³æƒ…</h3>
        <div id="detailContent" class="detail-list">
            <p style="text-align:center; color:#999;">è«‹é¸æ“‡ä¸Šæ–¹æ—¥æœŸ</p>
        </div>
    </div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="showPage(1, this)"><i>âš™ï¸</i>è¨­å®š</div>
    <div class="nav-item" onclick="showPage(2, this)"><i>âš¡</i>ä»»å‹™</div>
    <div class="nav-item" onclick="showPage(3, this)"><i>ğŸ›’</i>å•†åº—</div>
    <div class="nav-item" onclick="showPage(4, this)"><i>ğŸ’</i>èƒŒåŒ…</div>
    <div class="nav-item" onclick="showPage(5, this)"><i>ğŸ“Š</i>è¨˜éŒ„</div>
</div>

<script>
    // --- åˆå§‹åŒ– ---
    let state = {
        points: 0,
        tasks: [],
        items: [],
        inventory: {},
        dailyLogs: {} // { "2023-10-27": { done: {id: count}, buy: {name: count}, use: {name: count} } }
    };

    if (localStorage.getItem('taskMasterV4')) {
        state = JSON.parse(localStorage.getItem('taskMasterV4'));
    }

    function save() {
        localStorage.setItem('taskMasterV4', JSON.stringify(state));
        document.getElementById('displayPoints').innerText = state.points;
    }

    const getTodayStr = () => new Date().toLocaleDateString('en-CA');

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function showPage(num, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page' + num).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        
        if(num === 2) renderTasks();
        if(num === 3) renderShop();
        if(num === 4) renderInventory();
        if(num === 5) renderCalendar();
    }

    document.querySelectorAll('.day-btn').forEach(btn => btn.onclick = () => btn.classList.toggle('selected'));

    function saveTask() {
        const name = document.getElementById('tName').value.trim();
        const target = parseInt(document.getElementById('tTarget').value);
        const reward = parseInt(document.getElementById('tReward').value);
        const days = Array.from(document.querySelectorAll('.day-btn.selected')).map(b => parseInt(b.dataset.day));
        if(!name || isNaN(target)) return alert("è«‹å®Œæ•´å¡«å¯«");
        state.tasks.push({ id: Date.now(), name, target, reward, days });
        save(); alert("å·²æ–°å¢ä»»å‹™");
    }

    function saveItem() {
        const name = document.getElementById('iName').value.trim();
        const cost = parseInt(document.getElementById('iCost').value);
        if(!name || isNaN(cost)) return alert("è«‹å®Œæ•´å¡«å¯«");
        state.items.push({ name, cost });
        save(); alert("å·²æ–°å¢é“å…·");
    }

    function renderTasks() {
        const list = document.getElementById('activeTaskList');
        const today = new Date().getDay();
        const dateStr = getTodayStr();
        list.innerHTML = '';
        
        // ç¢ºä¿ä»Šæ—¥ Log å­˜åœ¨
        if (!state.dailyLogs[dateStr]) state.dailyLogs[dateStr] = { done: {}, buy: {}, use: {} };

        state.tasks.forEach(t => {
            if (t.days.length > 0 && !t.days.includes(today)) return;
            
            const count = state.dailyLogs[dateStr].done[t.id] || 0;
            const progress = Math.min((count / t.target) * 100, 100);
            const isFinished = count >= t.target;

            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <div class="row-header">
                    <div><strong>${t.name}</strong> <small style="color:var(--primary)">+${t.reward}</small></div>
                    <div style="font-size:12px;">${count} / ${t.target}</div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar ${isFinished ? 'complete' : ''}" style="width: ${progress}%"></div>
                </div>
                <button class="main-btn" style="padding:8px; font-size:14px; background:${isFinished ? '#ccc' : ''}" 
                    onclick="doTask(${t.id})" ${isFinished ? 'disabled' : ''}>
                    ${isFinished ? 'ä»Šæ—¥å·²é”æˆ âœ…' : '+1 å®Œæˆ'}
                </button>
            `;
            list.appendChild(div);
        });
    }

    function doTask(id) {
        const dateStr = getTodayStr();
        const task = state.tasks.find(t => t.id === id);
        state.dailyLogs[dateStr].done[id] = (state.dailyLogs[dateStr].done[id] || 0) + 1;
        state.points += task.reward;
        save();
        renderTasks();
    }

    function renderShop() {
        const list = document.getElementById('shopList');
        list.innerHTML = '';
        state.items.forEach(i => {
            const canAfford = state.points >= i.cost;
            list.innerHTML += `
                <div class="item-row row-header">
                    <div><strong>${i.name}</strong><br><small>${i.cost} ç©åˆ†</small></div>
                    <button class="main-btn" style="width:auto; background:${canAfford ? 'var(--warning)' : '#eee'}; color:${canAfford?'white':'#999'}" 
                        onclick="buyItem('${i.name}', ${i.cost})" ${canAfford ? '' : 'disabled'}>å…Œæ›</button>
                </div>`;
        });
    }

    function buyItem(name, cost) {
        const dateStr = getTodayStr();
        state.points -= cost;
        state.inventory[name] = (state.inventory[name] || 0) + 1;
        state.dailyLogs[dateStr].buy[name] = (state.dailyLogs[dateStr].buy[name] || 0) + 1;
        save(); renderShop(); alert("å…Œæ›æˆåŠŸï¼");
    }

    function renderInventory() {
        const list = document.getElementById('myItemsList');
        list.innerHTML = '';
        for (let name in state.inventory) {
            if (state.inventory[name] > 0) {
                list.innerHTML += `
                <div class="item-row row-header">
                    <div><strong>${name}</strong><br><small>æŒæœ‰: ${state.inventory[name]}</small></div>
                    <button class="main-btn" style="width:auto; background:var(--success)" onclick="useItem('${name}')">ä½¿ç”¨</button>
                </div>`;
            }
        }
    }

    function useItem(name) {
        const dateStr = getTodayStr();
        state.inventory[name]--;
        state.dailyLogs[dateStr].use[name] = (state.dailyLogs[dateStr].use[name] || 0) + 1;
        save(); renderInventory();
    }

    // --- æ—¥æ›†èˆ‡è©³æƒ… ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));

        for (let i = 1; i <= daysInMonth; i++) {
            const d = new Date(now.getFullYear(), now.getMonth(), i);
            const dStr = d.toLocaleDateString('en-CA');
            const hasData = state.dailyLogs[dStr];
            
            const div = document.createElement('div');
            div.className = `cal-day ${dStr === getTodayStr() ? 'cal-today' : ''} ${hasData ? 'cal-has-data' : ''}`;
            div.innerHTML = `${i} ${hasData ? '<span class="dot">â—</span>' : ''}`;
            div.onclick = () => showDetail(dStr);
            grid.appendChild(div);
        }
    }

    function showDetail(dateStr) {
        // UI åé¥‹ï¼šé¸ä¸­æ•ˆæœ
        document.querySelectorAll('.cal-day').forEach(el => el.classList.remove('cal-selected'));
        event.currentTarget.classList.add('cal-selected');

        const title = document.getElementById('detailDateTitle');
        const content = document.getElementById('detailContent');
        title.innerText = dateStr + " è©³æƒ…";
        
        const log = state.dailyLogs[dateStr] || { done: {}, buy: {}, use: {} };
        const dayOfWeek = new Date(dateStr).getDay();

        let html = "<strong>â”€â”€ ä»»å‹™åŸ·è¡Œåº¦ â”€â”€</strong><br>";
        
        // é¡¯ç¤ºè©²å¤©æ‰€æœ‰çš„ä»»å‹™ï¼ˆåŒ…å«æœªå®Œæˆï¼‰
        state.tasks.forEach(t => {
            if (t.days.length > 0 && !t.days.includes(dayOfWeek)) return;
            const count = log.done[t.id] || 0;
            const isDone = count >= t.target;
            html += `
                <div class="detail-item">
                    <span>${t.name} (${count}/${t.target})</span>
                    <span class="status-tag ${isDone ? 'tag-done' : 'tag-todo'}">${isDone ? 'å·²å®Œè³½' : 'æœªé”æ¨™'}</span>
                </div>`;
        });

        html += "<br><strong>â”€â”€ å•†åº—è¨˜éŒ„ â”€â”€</strong><br>";
        for(let n in log.buy) html += `<div class="detail-item"><span>å…Œæ›äº†ï¼š${n}</span><span>x${log.buy[n]}</span></div>`;
        for(let n in log.use) html += `<div class="detail-item"><span>ä½¿ç”¨äº†ï¼š${n}</span><span>x${log.use[n]}</span></div>`;
        
        content.innerHTML = html;
    }

    function clearAllData() { if(confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    
    document.getElementById('displayPoints').innerText = state.points;
</script>

</body>
</html>